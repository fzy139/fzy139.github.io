# 问题清单
### 0.轮廓不清晰
* 应该是没有约束feature loss/带着swap训练，直接原图约束没有不关注轮廓的损失


### 1.纹理不明显，模糊，3_1的问题？
* 尝试带swap 或者直接4_1
### 只用feature loss训练，无法变换颜色??
### 颜色单调,动态范围太小
* 已解决，vgg19要求输入图片范围在+-127

### 保留原图显著区域
1.用牛哥方法，在频域提细节，只对低频残留做变换，去看heatmap
2.自注意力开销太大，尝试自卷积

### 新方法的问题
* s

# 问题原因
1.batch=1的方向太飘

# 行动
## 9/24 
* 对比了原始avatar代码，发现vgg输入范围是+-127，而我的是0-1
* 尝试重新训练
* 可能是swap后模糊的原因
* 第一版pytorch代码也如此      
## 9/25
1.变换数据范围后明显色彩更丰富，但还是偏暗，且ep14 loss仍在下降
2.尝试用avatar里的数据均值
3.但还是细节纹理较少，可能是没有带swap训练decoder，要么就直接用4_1
## 9/26
1.4_1进行swap并不能增加纹理，反而变得相对模糊
2.可能是没有加feature loss的原因。
3.加了fl，明显有了纹理感，但可能因为31纹理还不是很明显，但清晰度更高了
4.训练过程中，fl下降较慢，而pixel loss的颜色修正较快，但容易飘
5.遇到了纯swap的固有问题,当content特征较少的区域（平滑）无法得到有效变换
6.尝试+ada loss，无明显效果，可能是batch的问题

## 10/7
1.写好了批量处理的代码
2.测试发现原图白色/低频区域(缺少纹理的地方)变换效果不好
3.大content图41变换效果更好，可能感受野更match，小图31效果更好
# 10/8
1.加入了FS算法，测试保留原图能力很强，但会出现disorder和噪声，而且tv loss 上升了，应该滤波

# 10/9
1.尝试softmax，基本无变化，因为ncc值基本在几千，ex后可能直接爆了，尝试对ncc进行缩放,若缩放的太小，则每个patch的权重过于均衡，最终图像出现全局颜色的平均
2.确实有效果，对与原来平滑区域出现了一些纹理，但感觉仅仅是一些波纹，并非原图的纹理，尝试用conv5
3.brdige的水纹发现，conv3中对其进行了变换，可以捕捉小纹理，conv4 可以捕捉大纹理，而忽略小的纹理，也有可能是感受野的问题被其他趋于中和了，应当解决一下swap对与图片尺度的不鲁棒性

#10/11
1.重写decoder代码，加入了在3—1层注入原图特征的入口
2.进行测试后发现效果不是很明显，可能原因是3-1到4-1稀释了一部分纹理
3.encoder41 对31的响应很低 只能恢复出一些纹理结构 而没有任何颜色
decoder的第一层即完成了颜色的变换，即decoder_41[1:]!=decoder_31
即我们想要41的颜色等大纹理的变换 和 31 对小纹理的变换
似乎只能通过downsample/upsanmple 可是channel不同？怎么加？

# 10/12
1.swap的另一个问题实际上就是只能匹配相同尺度的特征，

# 想法
0.在swap时加入channel  attention 干啥？
1.减去一部分，  用残差enc dec做变换
2.
2.分成子网络 颜色和纹理


# 11/11
1.swap可建模成一个二分图的匹配问题
其根本问题在于，匹配时只考虑当前片的最佳匹配，而不考虑全局总的期望值最大
2.

# 12/27
现有方法
one stage 
two stage swap 后decoder里修正 得益于
1.解决颜色接近的问题
可能原因 conv4中还是有不少颜色上的activation 导致匹配时颜色相近比纹理相近更胜一筹
可不可以把channel维做一个权重 提取出那些颜色无关的channel作match？
也可以在fine tune阶段学习这个参数
核心问题变成如何对不同channel的feature的一个划分或聚类。 
可以通过彩色和黑白相减
也可通过计算两个颜色相近的图片通道上的相关性。

2.VGG作分类的局限性
vgg不同通道是对不同物体或部件进行提取（纹理、颜色、边缘）
而用vgg得到的特征进行swap则是让xxx相近的进行替换
可否用style图训练一个vgg
这样得到的特征是不同画家、风格、


1.试图找出patch matching算法中可以权衡局部相似读和全局优化指标的方法

全局搜索 & 局部搜索 （和加mask权重的类似 即对patches as filter作）


## 01/06
1. 推导gram和swap之间的关系，发现swap只是优化和content的距离，没有考虑gram矩阵，初步打算在c+s和s卷积找最大
2.git commit
3.尝试修复训练到1500左右卡死 换驱动430无果
